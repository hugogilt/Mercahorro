<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Precios</title>
    <style>
        * {
            box-sizing: border-box;

        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        header {
            background-color: green;
            display: block;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            padding: 0 1rem 1rem;
        }

        header h1 {
            font-size: 3rem;
            margin: 3rem;
        }

        nav {
            display: flex;
            flex-direction: row;
            width: 100%;
            justify-content: space-between;
        }

        nav div {
            display: flex;
            justify-content: center;
            width: 33%;
            background-color: rgba(125, 125, 125, 0.8);
            padding: 1em;
            cursor: pointer;
        }

        main {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        input,
        select,
        button {
            margin: 5px;
            padding: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .autocomplete-suggestions {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background: white;
            width: 200px;
        }

        .autocomplete-suggestions div {
            padding: 5px;
            cursor: pointer;
        }

        .autocomplete-suggestions div:hover {
            background: #f0f0f0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }

        .modal.active {
            display: block;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <header>
        <h1>Mercahorro</h1>
        <nav>
            <div id="listaNav">Lista de la compra</div>
            <div id="productosNav">Productos</div>
            <div id="supermercadosNav">Supermercados</div>
        </nav>
    </header>
    <main>
        <div id="supermercadosContainer" class="hidden section">
            <h2>Agregar Supermercado</h2>
            <input type="text" id="nuevoSupermercado" placeholder="Nombre del supermercado">
            <button onclick="agregarSupermercado()">Agregar</button>
            <h2>Supermercados</h2>
            <ul></ul>
        </div>

        <div id="productosContainer" class="hidden section">
            <h2>Agregar Producto y Precio</h2>
            <div style="position: relative; display: inline-block;">
                <input type="text" id="producto" placeholder="Nombre del producto" oninput="mostrarSugerencias()">
                <div id="sugerencias" class="autocomplete-suggestions"></div>
            </div>
            <select id="supermercado">
                <option value="" selected>Selecciona un supermercado</option>
            </select>
            <input type="number" id="precio" placeholder="Precio (€)" step="0.01">
            <button onclick="agregarProducto()">Agregar</button>

            <h2>Productos</h2>
            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Supermercado</th>
                        <th>Precio (€)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="listaPrecios"></tbody>
            </table>
        </div>

        <div id="listaCompraContainer" class="section">
            <h2>Lista de la Compra</h2>
            <div style="position: relative; display: inline-block;">
                <input type="text" id="productoLista" placeholder="Nombre del producto"
                    oninput="mostrarSugerenciasLista()">
                <div id="sugerenciasLista" class="autocomplete-suggestions"></div>
            </div>
            <button onclick="agregarListaCompra()">Agregar a la lista</button>


            <ul id="listaCompra"></ul>
            <input type="checkbox" id="variosSupermercados"> Quiero hacer varios viajes
            <button onclick="calcularPrecios()">Calcular Mejor Opción</button>
            <div id="resultado">
                <h3 id="resultadoTotal"></h3>
                <h3 id="ahorras"></h3>
                <div id="detalleSupermercados"></div>
            </div>

            <div id="modal" class="modal">
                <h3>Productos más baratos en este supermercado</h3>
                <ul id="productosSupermercado"></ul>
                <button onclick="cerrarModal()">Cerrar</button>
            </div>
        </div>
    </main>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            mostrarListaCompra();
        });

        document.getElementById('productosNav').addEventListener('click', mostrarSeccionProductos);
        document.getElementById('supermercadosNav').addEventListener('click', mostrarSeccionSupermercados);
        document.getElementById('listaNav').addEventListener('click', mostrarSeccionListaCompra);

        function agregarSupermercado() {
            let supermercado = document.getElementById("nuevoSupermercado").value.trim();
            if (!supermercado) return;
            let supermercados = JSON.parse(localStorage.getItem("supermercados")) || [];
            if (!supermercados.includes(supermercado)) {
                supermercados.push(supermercado);
                localStorage.setItem("supermercados", JSON.stringify(supermercados));
            }
            document.getElementById("nuevoSupermercado").value = "";
            mostrarListaSupermercados();
        }

        function cargarSupermercados() {
            let supermercados = JSON.parse(localStorage.getItem("supermercados")) || [];
            let select = document.getElementById("supermercado");
            select.innerHTML = "<option value='' selected>Selecciona un supermercado</option>";
            supermercados.forEach(supermercado => {
                let option = document.createElement("option");
                option.value = supermercado;
                option.textContent = supermercado;
                select.appendChild(option);
            });
        }

        function agregarProducto() {
            let producto = document.getElementById("producto").value.trim();
            let supermercado = document.getElementById("supermercado").value;
            let precio = parseFloat(document.getElementById("precio").value);

            if (!producto || !supermercado || isNaN(precio) || precio <= 0) {
                alert("Por favor, introduce datos válidos.");
                return;
            }

            let lista = JSON.parse(localStorage.getItem("precios")) || [];
            lista.push({ producto, supermercado, precio });
            localStorage.setItem("precios", JSON.stringify(lista));

            mostrarListaProductos();
            document.getElementById("producto").value = "";
            document.getElementById("precio").value = "";
            document.getElementById("sugerencias").innerHTML = "";
        }

        function mostrarListaProductos() {
            // Usando innerHTML:
            // let lista = JSON.parse(localStorage.getItem("precios")) || [];
            // let tabla = document.getElementById("listaPrecios");
            // tabla.innerHTML = "";

            // lista.forEach((item, index) => {
            //     let fila = `<tr>
            //         <td>${item.producto}</td>
            //         <td>${item.supermercado}</td>
            //         <td>${item.precio.toFixed(2)}</td>
            //         <td><button onclick="eliminarProducto(${index})">Eliminar</button></td>
            //     </tr>`;
            //     tabla.innerHTML += fila;
            // });

            // Sin usar innerHTML:
            let lista = JSON.parse(localStorage.getItem("precios")) || [];
            let tabla = document.getElementById("listaPrecios");

            // Eliminar todas las filas previas
            while (tabla.firstChild) {
                tabla.removeChild(tabla.firstChild);
            }

            lista.forEach((item, index) => {
                let fila = document.createElement("tr");

                let tdProducto = document.createElement("td");
                tdProducto.textContent = item.producto;

                let tdSupermercado = document.createElement("td");
                tdSupermercado.textContent = item.supermercado;

                let tdPrecio = document.createElement("td");
                tdPrecio.textContent = item.precio.toFixed(2);

                let tdEliminar = document.createElement("td");
                let botonEliminar = document.createElement("button");
                botonEliminar.textContent = "Eliminar";
                botonEliminar.onclick = () => eliminarProducto(index);

                tdEliminar.appendChild(botonEliminar);

                fila.appendChild(tdProducto);
                fila.appendChild(tdSupermercado);
                fila.appendChild(tdPrecio);
                fila.appendChild(tdEliminar);

                tabla.appendChild(fila);
            });
        }

        function mostrarSeccionProductos() {
            let allSections = document.querySelectorAll('.section');
            for (let section of allSections) {
                if (section.id !== 'productosContainer') {
                    section.classList.add('hidden');
                } else {
                    section.classList.remove('hidden');
                }
            }
            mostrarListaProductos();
            cargarSupermercados();
        }

        function mostrarSeccionSupermercados() {
            let allSections = document.querySelectorAll('.section');
            for (let section of allSections) {
                if (section.id !== 'supermercadosContainer') {
                    section.classList.add('hidden');
                } else {
                    section.classList.remove('hidden');
                }
            }
            mostrarListaSupermercados();
        }

        function mostrarSeccionListaCompra() {
            let allSections = document.querySelectorAll('.section');
            for (let section of allSections) {
                if (section.id !== 'listaCompraContainer') {
                    section.classList.add('hidden');
                } else {
                    section.classList.remove('hidden');
                }
            }
            // Mientras no se pueda añadir productos a la lista desde otra sección
            // esto no sería necesario;
            // mostrarListaCompra();
        }

        function mostrarListaSupermercados() {
            let lista = JSON.parse(localStorage.getItem("supermercados")) || [];
            let ul = document.querySelector("#supermercadosContainer ul");

            //Limpiamos la lista
            while (ul.firstChild) {
                ul.removeChild(ul.firstChild);
            }

            lista.forEach((item, index) => {
                let li = document.createElement('li');
                li.textContent = item;
                let eliminarSupermercadoBtn = document.createElement('button');
                eliminarSupermercadoBtn.textContent = 'Eliminar';
                eliminarSupermercadoBtn.onclick = () => eliminarSupermercado(index);
                ul.appendChild(li);
                li.appendChild(eliminarSupermercadoBtn);
            });
        }

        function eliminarProducto(index) {
            let lista = JSON.parse(localStorage.getItem("precios")) || [];
            lista.splice(index, 1);
            localStorage.setItem("precios", JSON.stringify(lista));
            mostrarListaProductos();
        }

        function eliminarSupermercado(index) {
            let lista = JSON.parse(localStorage.getItem("supermercados")) || [];
            lista.splice(index, 1);
            localStorage.setItem("supermercados", JSON.stringify(lista));
            mostrarListaSupermercados();
        }

        function mostrarSugerencias() {
            let input = document.getElementById("producto").value.toLowerCase();
            let sugerenciasDiv = document.getElementById("sugerencias");
            let lista = JSON.parse(localStorage.getItem("precios")) || [];
            let productosUnicos = [...new Set(lista.map(item => item.producto))];

            sugerenciasDiv.innerHTML = "";
            if (input.length === 0) return;

            let sugerencias = productosUnicos.filter(prod => prod.toLowerCase().startsWith(input)).slice(0, 5);
            sugerencias.forEach(sugerencia => {
                let div = document.createElement("div");
                div.textContent = sugerencia;
                div.onclick = function () {
                    document.getElementById("producto").value = sugerencia;
                    sugerenciasDiv.innerHTML = "";
                };
                sugerenciasDiv.appendChild(div);
            });
        }

        function mostrarSugerenciasLista() {
            let input = document.getElementById("productoLista").value.trim().toLowerCase();
            let sugerenciasDiv = document.getElementById("sugerenciasLista");
            sugerenciasDiv.innerHTML = "";

            if (!input) return;

            let lista = JSON.parse(localStorage.getItem("precios")) || [];
            let productosUnicos = [...new Set(lista.map(item => item.producto))];
            let sugerencias = productosUnicos.filter(producto => producto.toLowerCase().startsWith(input));

            sugerencias.forEach(producto => {
                let div = document.createElement("div");
                div.textContent = producto;
                div.onclick = () => {
                    document.getElementById("productoLista").value = producto;
                    sugerenciasDiv.innerHTML = "";
                };
                sugerenciasDiv.appendChild(div);
            });
        }

        function mostrarListaCompra() {
            let listaCompra = JSON.parse(localStorage.getItem("listaCompra")) || [];
            let ul = document.getElementById("listaCompra");
            ul.innerHTML = "";
            listaCompra.forEach((producto, index) => {
                let li = `<li>${producto} <button onclick="eliminarListaCompra(${index})">Eliminar</button></li>`;
                ul.innerHTML += li;
            });
        }

        function agregarListaCompra() {
            let producto = document.getElementById("productoLista").value.trim();
            if (!producto) return;

            let listaCompra = JSON.parse(localStorage.getItem("listaCompra")) || [];
            if (!listaCompra.includes(producto)) {
                listaCompra.push(producto);
                localStorage.setItem("listaCompra", JSON.stringify(listaCompra));
            }

            document.getElementById("productoLista").value = "";
            document.getElementById("sugerenciasLista").innerHTML = "";
            mostrarListaCompra();
        }

        function eliminarListaCompra(index) {
            let listaCompra = JSON.parse(localStorage.getItem("listaCompra")) || [];
            listaCompra.splice(index, 1);
            localStorage.setItem("listaCompra", JSON.stringify(listaCompra));
            mostrarListaCompra();
        }


        let listaCompra;
        let listaPrecios;
        let supermercados;
        let mejoresOpcionesPorSupermercado;
        let precioTotal;

        function calcularPrecios() {
            listaCompra = JSON.parse(localStorage.getItem("listaCompra")) || [];
            listaPrecios = JSON.parse(localStorage.getItem("precios")) || [];
            let variosSupermercados = document.getElementById("variosSupermercados").checked;
            let precioMasBajoUnViaje;

            mejoresOpcionesPorSupermercado = calcularMejoresOpcionesPorSupermercado();

            // Para saber el total que se gastaría
            calcularPreciosVariosViajes();
            // Para saber el total que se gastaría en el super que sale más barato
            precioMasBajoUnViaje = encontrarPrecioMasBajoUnViaje(calcularPreciosUnViaje()).precio;

            //Asigno precios en función de la casilla marcada
            supermercados = variosSupermercados ? calcularPreciosVariosViajes() : calcularPreciosUnViaje();

            // Ordeno los supermercados de más baratos a más caros
            let ordenados = Object.entries(supermercados).sort((a, b) => a[1] - b[1]);


            if (variosSupermercados) {
                document.getElementById("resultadoTotal").innerText = `Total compra: ${(precioTotal).toFixed(2)}€`;
                document.getElementById("ahorras").innerText = `Haciendo varios viajes ahorras: ${(precioMasBajoUnViaje - precioTotal).toFixed(2)}€`
            } else {
                document.getElementById("resultadoTotal").innerText = ordenados.length > 0 ? `Mejor opción: ${ordenados[0][0]} con un total de ${ordenados[0][1].toFixed(2)}€` : "No hay suficientes datos para calcular.";
                document.getElementById("ahorras").innerText = `Si hicieses varios viajes ahorrarías: ${(precioMasBajoUnViaje - precioTotal).toFixed(2)}€`
            }

            let detalle = "<h3>Precios por supermercado:</h3>";

            ordenados.forEach(([supermercado, total]) => {
                if (variosSupermercados) {
                    detalle += `<li><button onclick='mostrarModal("${supermercado}")'>${supermercado}</button>: €${total.toFixed(2)}</li>`;
                } else {
                    detalle += `<li>${supermercado}: €${total.toFixed(2)}</li>`;
                }
            });

            document.getElementById("detalleSupermercados").innerHTML = detalle;
        }

        function mostrarModal(supermercado) {
            let listaCompra = JSON.parse(localStorage.getItem("listaCompra")) || [];
            let listaPrecios = JSON.parse(localStorage.getItem("precios")) || [];
            let ul = document.getElementById("productosSupermercado");
            ul.innerHTML = "";

            listaCompra.forEach(producto => {
                let preciosProducto = listaPrecios.filter(item => item.producto === producto);
                let mejorPrecio = Math.min(...preciosProducto.map(item => item.precio));
                let mejorSuper = preciosProducto.find(item => item.precio === mejorPrecio).supermercado;

                if (mejorSuper === supermercado) {
                    let li = document.createElement("li");
                    li.textContent = producto;
                    ul.appendChild(li);
                }
            });

            document.getElementById("modal").classList.add("active");
        }

        function cerrarModal() {
            document.getElementById("modal").classList.remove("active");
        }

        function calcularPreciosUnViaje() {
            supermercados = {};
            listaCompra.forEach(producto => {
                let preciosProducto = listaPrecios.filter(item => item.producto === producto);
                preciosProducto.forEach(({ supermercado, precio }) => {
                    if (!supermercados[supermercado]) supermercados[supermercado] = 0;
                    supermercados[supermercado] += precio;
                });
            });
            return supermercados;
        }

        function calcularPreciosVariosViajes() {
            supermercados = {};
            precioTotal = 0;
            Object.entries(mejoresOpcionesPorSupermercado).forEach(([producto, { supermercado, precio }]) => {
                if (!supermercados[supermercado]) {
                    supermercados[supermercado] = 0;
                }
                supermercados[supermercado] += precio;
                precioTotal += parseFloat(precio);
            });
            return supermercados;
        }

        function calcularMejoresOpcionesPorSupermercado() {
            mejoresOpcionesPorSupermercado = {};

            listaCompra.forEach(producto => {
                let preciosProducto = listaPrecios.filter(item => item.producto === producto);

                preciosProducto.forEach(({ supermercado, precio }) => {
                    if (!mejoresOpcionesPorSupermercado[producto] || precio < mejoresOpcionesPorSupermercado[producto].precio) {
                        mejoresOpcionesPorSupermercado[producto] = { supermercado, precio };
                    }
                });
            });

            return mejoresOpcionesPorSupermercado;
        }

        function encontrarPrecioMasBajoUnViaje(supermercados) {
            let supermercadoMasBarato = null;
            let precioMasBajo = Infinity;

            Object.entries(supermercados).forEach(([supermercado, precio]) => {
                if (precio < precioMasBajo) {
                    precioMasBajo = precio;
                    supermercadoMasBarato = supermercado;
                }
            });

            return { supermercado: supermercadoMasBarato, precio: precioMasBajo };
        }




    </script>

</body>

</html>